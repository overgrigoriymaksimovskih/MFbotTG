<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Информация о пользователе</title>
    <!-- Подключаем Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div th:if="${error}">
    <p style="color: red;" th:text="${error}"></p>
</div>
<div th:if="${userData}">
    <h2>Информация о пользователе:</h2>
    <ul>
        <li th:each="entry : ${userData}" th:text="${entry.key} + ': ' + ${entry.value}"></li>
    </ul>
</div>

<!-- JavaScript для обработки initData -->
<script>
    // Ждём загрузки DOM
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM загружен. Проверяем Telegram Web App...');

        // Проверяем, загружается ли страница в Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            console.log('Telegram Web App доступен.');
            const initData = window.Telegram.WebApp.initData;
            console.log('initData:', initData);  // Отладка: покажет, что в initData

            // Редирект ТОЛЬКО если userData НЕ загружено и initData есть
            if (initData && ![[${userData}]]) {
                console.log('userData нет, и initData есть — делаем редирект.');
                // Отправляем initData на сервер через редирект с query-параметром
                window.location.href = '/api/redirect?initData=' + encodeURIComponent(initData);
            } else {
                console.log('Редирект не нужен: initData пустой или userData уже есть.');
            }
        } else {
            console.log('Telegram Web App НЕ доступен (возможно, открыто не из Telegram).');
            // Если не в Telegram, ничего не делаем — ошибка рендерится через Thymeleaf
        }
    });
</script>
</body>
</html>
